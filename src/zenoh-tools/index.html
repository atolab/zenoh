<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-jsonview/1.2.3/jquery.jsonview.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-jsonview/1.2.3/jquery.jsonview.min.css" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/css-spinning-spinners/1.1.0/load8.css" />
    
        <style type="text/css">
            body {font-family:sans-serif;}
            #commandpanel {height:6vh;}
            #displaypanel {height:90vh;}
            #server {float:left;}
            #graph {
                float:left;
                width:   50%;
                height: 100%;
                border: 1px solid lightgrey;
            }
            #data {
                float:left;
                width:   45%;
                height: 100%;
                overflow:scroll;
                border: 1px solid lightgrey;
            }
            button {
                padding-left:30px;
                padding-right:30px;
            }
            .loading:before { 
                position:relative; 
                left: -10px; top: 7px; 
                font-size: 1px; 
                float:left; 
            }
            #message{ 
                color:red;
                font-weight:bold;
                font-size: 12px; 
            }

        </style>
    </head>
<body>
<div id="commandpanel">
    <form id="server" onsubmit="redraw();return false">
        <input id="serveraddress" type="text" name="address" value="http://127.0.0.1:8000" size="50"/>
        <div><span id="message"></span></div>
    </form>
    <button id="refresh"     onclick="refresh()"    >Refresh</button>
    <button id="autorefresh" onclick="autorefresh()">Auto refresh</button>
    <button id="redraw"      onclick="redraw()"     >Redraw</button>
</div>
<div id="displaypanel">
    <div id="graph"></div>
    <div id="data"></div>
</div>

<script type="text/javascript">
    $.ajaxSetup({timeout:500});

    var tree_colors = ["#7777FF","#FF0000","#00FF00","#FFFF00","#00FFFF","#FF00FF"]

    var nodes = new vis.DataSet();
    var edges = new vis.DataSet();
    var container = document.getElementById('graph');
    var data = {
        nodes: nodes,
        edges: edges
    };
    var default_node_color = {background:"#7BBCFF", border:"#00356D", 
                              highlight:{background:"#1387FF", border:"#00356D"}};
    var default_node_text_color = "#000000";
    var disabled_node_color = {background:"#F5F5F5", border:"#F5F5F5", 
                               highlight:{background:"#F5F5F5", border:"#F5F5F5"}};
    var disabled_node_text_color = "#BBBBBB";
    var default_edge_color = {color:"grey", highlight:"grey", hover:"grey"};
    var disabled_edge_color = {color:"#EEEEEE", highlight:"#EEEEEE", hover:"#EEEEEE"};
    var flow_edge_color = {color:"#1387FF", highlight:"#1387FF", hover:"#1387FF"};
               
    var options = {
        edges:{font:{face:'courier', size:10, multi:"html", bold:{face:'courier bold', size:12}}, selectionWidth:0},
        nodes:{shape:"box", heightConstraint:50, widthConstraint:50, margin:10, 
               font:{face:'courier', size:10, multi:"html", bold:{face:'courier bold', size:12}},
               color:default_node_color},
        physics:{enabled:true}
    };
    var network;

    redraw();

    function parentLinkId(from, to, tree_nb) {
        return "" + tree_nb + "_" + from + "_" + to;
    }
    
    function brokenLinkId(node1, node2) {
        return "bk_" + (node1>node2?node1:node2) + "_" + (node1>node2?node2:node1);
    }

    function updateDataSet(set, elements) {
        set.update(elements);
        set.getIds().forEach(function(id) {
            if(elements.find(function(elem){return elem.id === id}) === undefined) {
                try{ set.remove(id); } catch(err) {}
            }
        });
    }

    function containsLinkBetween(edgeset, node1, node2) {
        return edgeset.find(function (edge) {
                return (edge.from === node1 && edge.to === node2) ||
                    (edge.from === node2 && edge.to === node1);
            }) !== undefined ;
    }

    function updateNodes(services) {
        newnodes = Object.keys(services).map( function(id, idx) {
            label = "<b>" + services[id].pid.substring(0, 6) + "..</b>" + "\n\n" + 
                    services[id].locators[0].split("/")[1].split(":")[0] + "\n" + 
                    services[id].locators[0].split("/")[1].split(":")[1];
            return {id: services[id].pid, label: label};
        });
        updateDataSet(nodes, newnodes);
    }

    function getSessionForPeer(service, peerid) {
        peer = service.router.peers.find(function(peer){return (peer.pid === peerid);});
        return service.sessions.find(function(session){return (session.sid === peer.sid);});
    }

    function updateEdges(services) {
        treelinks = Object.keys(services).map( function(id, idx) {
            return services[id].router.tree_set
                .filter( function (tree){ return tree.local.parent != null;})
                .map( function (tree){ 
                    tpup = getSessionForPeer(services[id], tree.local.parent).stats.out_msgs_tp;
                    tpdwn = getSessionForPeer(services["/_z_/services/" + tree.local.parent], services[id].pid).stats.out_msgs_tp;
                    label= "<b>" + (tpup + tpdwn).toString() + " m/s" + "</b>";
                    if ((tpup + tpdwn) > 0)
                    {
                        arrows = '';
                        if (tpup > 0) {arrows += 'to, '}
                        if (tpdwn > 0) {arrows += 'from, '}
                        return {
                        id: parentLinkId(services[id].pid, tree.local.parent),
                        from: services[id].pid, to: tree.local.parent, 
                        label:label, arrows: arrows, 
                        color:flow_edge_color, dashes:false, width:4};
                    }
                    else
                    {
                        return {
                        id: parentLinkId(services[id].pid, tree.local.parent),
                        from: services[id].pid, to: tree.local.parent, 
                        label:label, arrows:'', 
                        color:null, dashes:false, width:2};
                    }
                });
            }).flat();

        brokenLinks = Object.keys(services).map( function(id, idx) {
            return services[id].router.peers
                .filter( function (peer){ return !containsLinkBetween(treelinks, services[id].pid, peer.pid);})
                .map( function (peer){ 
                    return {
                        id: brokenLinkId(services[id].pid, peer.pid),
                        from: services[id].pid, to: peer.pid, 
                        label:"<b></b>", arrows:'', 
                        color:null, dashes:true, width:1};
                });
            }).flat();
        
        links = treelinks.concat(brokenLinks);
        updateDataSet(edges, links);
    }

    function failure(){
        $("#message").html("Unable to contact server!");

        edges.forEach(function(edge){
            edge.label = "<b></b>";
            edge.arrows = "";
            edge.color = null;
            if(edge.width > 2){edge.width = 2;};
            edges.update(edge);
        });

        options.nodes.color = disabled_node_color;
        options.edges.color = disabled_edge_color;
        options.nodes.font.color = disabled_node_text_color;
        options.nodes.font.bold.color = disabled_node_text_color;
        network.setOptions(options);

        $("#data").html("");
    }

    function cleanfailure(){
        $("#message").html("");

        options.nodes.color = default_node_color;
        options.edges.color = default_edge_color;
        options.nodes.font.color = default_node_text_color;
        options.nodes.font.bold.color = default_node_text_color;
        network.setOptions(options);
    }

    function update(services) {
        cleanfailure();
        updateNodes(services);
        updateEdges(services);
        showDetails(services);
    }

    function refresh() {
        $.getJSON($("#serveraddress").val() + "/_z_/services/**", update)
        .fail(failure);
    }

    function autorefresh() {
        $("#autorefresh").toggleClass("loading");
        if($("#autorefresh").hasClass("loading"))
        {
            function periodicupdate(){
                $.getJSON($("#serveraddress").val() + "/_z_/services/**", function(services) {
                    update(services);
                    if($("#autorefresh").hasClass("loading"))
                    {
                        setTimeout(periodicupdate, 500);
                    }
                })
                .fail(function() {
                    failure();
                    if($("#autorefresh").hasClass("loading"))
                    {
                        setTimeout(periodicupdate, 500);
                    }
                });
            }
            periodicupdate();
        }
    }

    function showDetails(services)
    {
        if(network && network.getSelectedNodes()[0])
        {
            if(services && services["/_z_/services/" + network.getSelectedNodes()[0]])
            {
                $("#data").JSONView(services["/_z_/services/" + network.getSelectedNodes()[0]], { collapsed: false });
            }
            else
            {
                $.getJSON($("#serveraddress").val() + "/_z_/services/" + network.getSelectedNodes()[0], function(services) {
                    $("#data").JSONView(services["/_z_/services/" + network.getSelectedNodes()[0]], { collapsed: false });
                })
                .fail(failure);
            }
        }
        else
        {
            $("#data").html("");
        }
    }

    function resetgraph(){
        network = new vis.Network(container, data, options);
        network.on("click", showDetails);
        network.on("dragStart", showDetails);
    }

    function redraw() {
        $.getJSON($("#serveraddress").val() + "/_z_/services/**", function(services) {
            resetgraph();
            update(services);
        })
        .fail(function() {
            resetgraph();
            failure();
        });
    }
</script>

</body>
</html>